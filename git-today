#!/bin/bash

# Get the current git user
AUTHOR=$(git config user.name)

# Define the start of today
SINCE="05:00:00"
TODAY=$(date +%Y-%m-%d)

# Calculate committed additions and deletions
STATS=$(git log --author="$AUTHOR" --since="$TODAY $SINCE" --numstat --pretty=tformat: | 
    awk '{add += $1; del += $2} END {printf "%d %d", add, del}')

ADDITIONS=$(echo $STATS | awk '{print $1}')
DELETIONS=$(echo $STATS | awk '{print $2}')

# Count the number of commits
COMMITS=$(git log --author="$AUTHOR" --since="$TODAY $SINCE" --oneline | wc -l | xargs)

# Output the result
BOLD='\033[1m'
NC='\033[0m'

WORK_TIME_STRING=""
if [ "$COMMITS" -gt 1 ]; then
    # Get commit timestamps
    TIMESTAMPS=$(git log --author="$AUTHOR" --since="$TODAY $SINCE" --pretty=format:%ct)

    # Find first and last commit timestamp
    FIRST_COMMIT_TIME=$(echo "$TIMESTAMPS" | sort -n | head -1)
    LAST_COMMIT_TIME=$(echo "$TIMESTAMPS" | sort -n | tail -1)

    # Calculate work time in seconds
    WORK_TIME_SECONDS=$((LAST_COMMIT_TIME - FIRST_COMMIT_TIME))

    # Format work time
    if [ "$WORK_TIME_SECONDS" -gt 0 ]; then
        WORK_TIME_HOURS=$((WORK_TIME_SECONDS / 3600))
        WORK_TIME_MINUTES=$(((WORK_TIME_SECONDS % 3600) / 60))
        WORK_TIME_STRING=" in ${BOLD}${WORK_TIME_HOURS}h ${WORK_TIME_MINUTES}m${NC}"
    fi
fi

echo -e "Today you've made a total of ${BOLD}${ADDITIONS:-0} additions${NC} and ${BOLD}${DELETIONS:-0} deletions${NC} across ${BOLD}${COMMITS:-0} commits${NC}${WORK_TIME_STRING}."
